<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <style>
        html,
        body {
            background: #fff;
            font-family: Helvetica, Arial, Tahoma, sans-serif;
            margin: 0;
            padding: 0;
        }

        path {
            fill: none;
            stroke: #343434;
        }

        .result {
            fill: none;
            stroke: #343434;
            stroke-width: 4px;
        }

        h1,
        h2,
        h3 {
            padding-left: 140px;
            padding-top: 0px;
        }

        .fog {
            filter: brightness(0.05);
        }
    </style>
</head>

<body>
    <svg xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' height=557 width=800>
        <defs>
            <filter id="filter-map" x="-0.15000001" y="-0.15000001" width="1.3" height="1.3"
                color-interpolation-filters="sRGB">
                <feGaussianBlur stdDeviation="4" in="SourceGraphic" result="result1" id="feGaussianBlur4202" />
                <feTurbulence type="fractalNoise" baseFrequency="0.05" numOctaves="4" result="result0"
                    id="feTurbulence4204" />
                <feDisplacementMap in2="result0" scale="20" xChannelSelector="R" yChannelSelector="G" in="result1"
                    result="result2" id="feDisplacementMap4206" />
                <feGaussianBlur stdDeviation="3" in="SourceGraphic" result="result4" id="feGaussianBlur4208" />
                <feComposite in2="result2" operator="arithmetic" k1="1.5" k2="-0.25" k3="0.5" k4="0" in="result4"
                    result="result5" id="feComposite4210" />
            </filter>
        </defs>
    </svg>

    <script src='https://cdnjs.cloudflare.com/ajax/libs/d3/3.4.11/d3.min.js'></script>

    <script>

        (function setupMap() {
            // 0. setup groups
            // ----------------------------------
            var svg = d3.select('svg');
            var wrapper = svg.append('g').attr({ 'class': 'map-wrapper' });
            var background = wrapper.append('g').attr({ 'class': 'background' });
            var characters = wrapper.append('g').attr({ 'class': 'characters' });

            // 1. Setup the mask
            // ----------------------------------
            var maskGroup = svg.append('mask')
                .attr({ id: 'map-mask' });

            maskGroup.append('rect')
                .attr('width', '100%')
                .attr('height', '100%')
                .style('fill', '#fff');

            // full version
            var visibleMap = background.append("image")
                .attr({
                    // TODO: use different background image
                    'xlink:href': 'https://media-waterdeep.cursecdn.com/attachments/3/44/lmop5.jpg',
                    'preserveAspectRatio': 'none',
                    'class': 'visibleArea', x: 0, y: 0,
                    height: '100%', width: '100%'
                });

            background.append('rect')
                .attr('width', '100%')
                .attr('height', '100%')
                .attr('mask', 'url(#map-mask)');

            // 3. Add a starting circle to break the fog
            // ----------------------------------
            // create a masked path to show visible nodes   
            var vertices = [];

            function updateFog() {
                var masks = maskGroup.selectAll('.breakFog')
                    .data(vertices);

                var newMasks = masks.enter()
                    .append('rect')
                    .style({
                        fill: '#000000',
                        opacity: 1
                    });

                // update existing masks
                masks
                    .attr({
                        'class': 'breakFog',
                        x: function (d) { return d.x - 43; },
                        y: function (d) { return d.y - 43; },
                        filter: 'url(#filter-map)',
                        width: 86,
                        height: 86
                    });

                var newStyle = { fill: '#000', opacity: 1 };
                masks.style(newStyle);

                masks.exit().remove();

            };

            // Call it immediately 
            updateFog();

            // then, call whenever a point is added
            wrapper.on('click', function () {
                vertices.push({
                    x: d3.event.clientX,
                    y: d3.event.clientY
                });
                updateFog();
            });

        })();

    </script>

</body>

</html>